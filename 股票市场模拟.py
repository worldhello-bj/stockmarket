# -*- coding: utf-8 -*-
"""
股票市场模拟.py
重构主函数，支持多策略股民。
"""
import random
from 市场撮合引擎 import 市场撮合引擎
from 股民 import 趋势型股民, 逆势型股民, 随机型股民
from 发行人 import 发行人, 股票名称列表, 发行新股数量

# ---------------- 普通股民初始化 ----------------
股民列表 = []
for i in range(50):
    if i % 3 == 0:
        股民对象 = 趋势型股民(f"趋势型股民{i+1}", random.randint(10000, 50000), random.randint(20, 50))
    elif i % 3 == 1:
        股民对象 = 逆势型股民(f"逆势型股民{i+1}", random.randint(10000, 50000), random.randint(90, 100))
    else:
        股民对象 = 随机型股民(f"随机型股民{i+1}", random.randint(10000, 50000), random.randint(0, 100))
    for 名称 in 股票名称列表:
        股民对象.个股信心表[名称] = random.randint(30, 80)
    股民列表.append(股民对象)

发行人对象 = 发行人()
全部股民列表 = [发行人对象] + 股民列表

# ---------------- 撮合引擎 ----------------
引擎 = 市场撮合引擎()

# ---------------- 消息广播函数 ----------------
def 广播消息(股民列表, 股票名称, 变化量):
    for 股民对象 in 股民列表:
        旧值 = 股民对象.个股信心表.get(股票名称, 50)
        新值 = max(0, min(100, 旧值 + 变化量))
        股民对象.个股信心表[股票名称] = 新值

# ---------------- 主循环 ----------------
初始价格字典 = {"地产股": 10, "科技股": 11, "医药股": 9}
日志列表 = []
for 当前时钟 in range(100):
    if 当前时钟 == 30:
        广播消息(全部股民列表, "地产股", +25)
        日志列表.append(f"[时钟{当前时钟}] 广播：地产股信心+25")
    if 当前时钟 == 60:
        广播消息(全部股民列表, "科技股", -30)
        日志列表.append(f"[时钟{当前时钟}] 广播：科技股信心-30")
    if 当前时钟 == 0:
        当前价格字典 = 初始价格字典.copy()
    else:
        当前价格字典 = {
            名称: round((初始价格字典[名称] * random.uniform(0.9, 1.1)), 2)
            if 引擎.最新成交价(名称) is None else 引擎.最新成交价(名称)
            for 名称 in 股票名称列表
        }
    for 股民对象 in 全部股民列表:
        选中股票名称 = random.choice(股票名称列表)
        新委托单 = 股民对象.生成委托单(选中股票名称, 当前价格字典, 引擎)
        if 新委托单:
            引擎.提交委托单(新委托单)
            持仓 = 股民对象.持仓数量表.get(选中股票名称, 0)
            日志列表.append(
                f"[时钟{当前时钟}] {股民对象.姓名} {'买入' if 新委托单.买卖方向=='买' else '卖出'} {选中股票名称} 价:{新委托单.委托价格} 量:{新委托单.委托数量} 现金:{股民对象.现金余额:.2f} 持仓:{持仓}"
            )
    if 当前时钟 % 50 == 0:
        for 名称 in 股票名称列表:
            最新价 = 引擎.最新成交价(名称)
            日志列表.append(f"[时钟{当前时钟}] {名称} 最新成交价: {最新价}")
        for 股民对象 in 股民列表:
            日志列表.append(f"[时钟{当前时钟}] {股民对象.姓名} 现金: {股民对象.现金余额:.2f} 持仓: {股民对象.持仓数量表}")

with open("市场动态日志.txt", "w", encoding="utf-8") as f:
    for line in 日志列表:
        f.write(line + "\n")

from 股票市场总结 import 市场总结分析
市场总结分析(引擎, 股票名称列表)